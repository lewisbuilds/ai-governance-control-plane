name: governance-gate

on:
  pull_request:
  push:
    branches: [ main, bigrich ]

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      POSTGRES_USER: mcp
      POSTGRES_PASSWORD: ci-gate-pass
      POSTGRES_DB: mcpgov
      DATABASE_URL: postgresql://mcp:ci-gate-pass@db:5432/mcpgov
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start stack
        run: |
          docker compose up -d --build

      - name: Wait for db-migrate to complete
        shell: bash
        run: |
          echo "Waiting for db-migrate service to complete..."
          # Wait for completion message in logs (up to 2 minutes)
          for i in {1..60}; do
            echo "Attempt $i: Checking db-migrate logs..."
            
            # Check if completion message appears in logs
            if docker compose logs db-migrate 2>/dev/null | grep -q "=== Migration complete ==="; then
              echo "db-migrate completed successfully (found completion message)"
              docker compose logs db-migrate | tail -15
              
              # Verify exit code
              exit_code=$(docker compose ps db-migrate --format json 2>/dev/null | jq -r '.[0].ExitCode // "0"')
              if [ "$exit_code" != "0" ] && [ "$exit_code" != "null" ]; then
                echo "WARNING: db-migrate exit code was $exit_code"
                exit 1
              fi
              exit 0
            fi
            
            # Check for error patterns
            if docker compose logs db-migrate 2>/dev/null | grep -q "ERROR:"; then
              echo "db-migrate encountered an error"
              docker compose logs db-migrate
              exit 1
            fi
            
            sleep 2
          done
          echo "db-migrate did not complete in time (waited 2 minutes)"
          docker compose logs db-migrate
          exit 1

      - name: Wait for gateway
        shell: bash
        run: |
          for i in {1..60}; do
            curl -sf http://localhost:8080/mcp && exit 0
            sleep 2
          done
          echo "Gateway did not become healthy in time" >&2
          docker compose logs
          exit 1

      - name: List services
        run: |
          curl -s http://localhost:8080/mcp || true

      - name: Policy validate example
        shell: bash
        run: |
          cat > /tmp/policy-input.json <<'JSON'
          {"payload":{"model_class":"vision","use_case":"general","risk":{"data_sensitivity":1,"model_complexity":1,"deployment_impact":1,"monitoring_maturity":3}}}
          JSON
          curl -s -X POST -H 'Content-Type: application/json' --data @/tmp/policy-input.json http://localhost:8080/mcp-policy/validate | tee /tmp/validate.json
          grep -q '"allowed"' /tmp/validate.json

      - name: Audit log example
        shell: bash
        run: |
          cat > /tmp/audit.json <<'JSON'
          {"event_type":"policy_decision","subject":"demo@1.0.0","decision":true,"details":{"note":"ci smoke"}}
          JSON
          curl -s -X POST -H 'Content-Type: application/json' --data @/tmp/audit.json http://localhost:8080/mcp-audit/log | tee /tmp/audit.json.out
          grep -q '"entry_hash"' /tmp/audit.json.out

      - name: Compose logs on failure
        if: failure()
        run: docker compose logs --tail=200
