name: CI

on:
  pull_request:
    branches: [ "**" ]
  push:
    branches: [ "**" ]

permissions:
  contents: read
  security-events: write

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'services/**'
              - 'scripts/**'
              - 'infra/**'
              - 'clients/**'
              - 'policies/**'
            docs:
              - 'docs/**'
              - '**/*.md'

  lint:
    name: Ruff lint
    runs-on: ubuntu-latest
    needs: changes
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt
      - run: ruff check --output-format=github .
      - name: Black (check only)
        run: black --check . --line-length 100 --target-version py311
      - name: Pylint
        run: pylint services
      - name: Vulture (dead code)
        run: |
          vulture . scripts/vulture_whitelist.py \
            --min-confidence 80 \
            --exclude "wheelhouse,infra/keys,backups,__pycache__"

  typecheck:
    name: mypy
    runs-on: ubuntu-latest
    needs: changes
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt
      - run: mypy services clients

  test:
    name: Unit tests with coverage
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt
      - run: pytest -m "not integration" --cov-fail-under=0
      - name: Upload coverage XML
        uses: actions/upload-artifact@v5
        with:
          name: coverage-xml
          path: coverage.xml
          if-no-files-found: warn

  build-images:
    name: Build images (no push)
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, changes]
    if: github.event_name != 'pull_request' || (needs.changes.outputs.code == 'true' && !contains(toJson(github.event.pull_request.labels), 'skip-integration'))
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python (for optional wheelhouse populate)
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      - name: Populate wheelhouse if missing
        run: |
          if [ ! -d wheelhouse ] || [ -z "$(ls -A wheelhouse 2>/dev/null)" ]; then
            python -m pip install --upgrade pip
            python scripts/download-wheels.py
          else
            echo "wheelhouse/ already present; skipping population"
          fi
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build mcp-gateway
        id: build_gateway
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/mcp-gateway/Dockerfile
          tags: gateway:test
          load: true
          provenance: false
          sbom: false
      - name: Build mcp-policy
        id: build_policy
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/mcp-policy/Dockerfile
          tags: policy:test
          load: true
          provenance: false
          sbom: false
      - name: Build mcp-audit
        id: build_audit
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/mcp-audit/Dockerfile
          tags: audit:test
          load: true
          provenance: false
          sbom: false
      - name: Build mcp-lineage
        id: build_lineage
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/mcp-lineage/Dockerfile
          tags: lineage:test
          load: true
          provenance: false
          sbom: false

  trivy:
    name: Trivy scan
    runs-on: ubuntu-latest
    needs: build-images
    if: needs.build-images.result == 'success'
    permissions:
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        image: [gateway, policy, audit, lineage]
    steps:
      - uses: actions/checkout@v6
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build ${{ matrix.image }} image for scanning
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/mcp-${{ matrix.image }}/Dockerfile
          tags: ${{ matrix.image }}:test
          load: true
          provenance: false
          sbom: false
      - name: Scan ${{ matrix.image }} image
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'image'
          image-ref: '${{ matrix.image }}:test'
          format: 'sarif'
          output: 'trivy-${{ matrix.image }}.sarif'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
      - name: Upload SARIF for ${{ matrix.image }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-${{ matrix.image }}.sarif'
          category: 'trivy-${{ matrix.image }}'

  sbom:
    name: SBOM (CycloneDX)
    runs-on: ubuntu-latest
    needs: build-images
    if: |
      needs.build-images.result == 'success' &&
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    strategy:
      fail-fast: false
      matrix:
        image: [gateway, policy, audit, lineage]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python (for optional wheelhouse)
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      - name: Populate wheelhouse if missing
        run: |
          if [ ! -d wheelhouse ] || [ -z "$(ls -A wheelhouse 2>/dev/null)" ]; then
            python -m pip install --upgrade pip
            python scripts/download-wheels.py
          else
            echo "wheelhouse/ already present; skipping population"
          fi
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build ${{ matrix.image }} image for SBOM
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/mcp-${{ matrix.image }}/Dockerfile
          tags: ${{ matrix.image }}:sbom
          load: true
          provenance: false
          sbom: false
      - name: Generate SBOM for ${{ matrix.image }}
        uses: anchore/sbom-action@v0
        with:
          image: '${{ matrix.image }}:sbom'
          format: 'cyclonedx-json'
          artifact-name: 'sbom-${{ matrix.image }}.cdx.json'
          upload-artifact: true
          upload-artifact-retention: 0
          upload-release-assets: false

  integration:
    name: Integration tests (Docker Compose)
    runs-on: ubuntu-latest
    needs: [test, changes, trivy]
    if: |
      (github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'run-integration')) &&
      needs.changes.outputs.code == 'true'
    env:
      POSTGRES_USER: mcp
      POSTGRES_PASSWORD: ci-local-pass
      POSTGRES_DB: mcpgov
      DATABASE_URL: postgresql://mcp:ci-local-pass@db:5432/mcpgov
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Set up Python (for wheelhouse)
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      - name: Populate wheelhouse
        run: |
          python -m pip install --upgrade pip
          python scripts/download-wheels.py
      - name: Docker info
        run: |
          docker --version
          docker compose version
      - name: Build all images
        run: |
          docker compose build
      - name: Start database and run migrations
        run: |
          echo "Starting database and migration services..."
          docker compose up -d db
          docker compose up db-migrate
          
          echo "Verifying migration completion..."
          if docker compose logs db-migrate 2>/dev/null | grep -q "=== Migration complete ==="; then
            echo "✓ Migrations completed successfully"
            docker compose logs db-migrate | tail -10
          else
            echo "✗ Migration completion marker not found"
            docker compose logs db-migrate
            exit 1
          fi
      - name: Start application services
        run: |
          docker compose up -d mcp-policy mcp-lineage mcp-audit mcp-gateway
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - name: Run full test suite
        env:
          PYTEST_ADDOPTS: "-q"
        run: |
          pytest -m integration --cov-fail-under=0
      - name: Tear down stack
        if: always()
        run: |
          docker compose down -v --remove-orphans

