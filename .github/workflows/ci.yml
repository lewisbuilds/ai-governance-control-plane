name: CI

on:
  pull_request:
    branches: [ "**" ]
  push:
    branches: [ "**" ]

permissions:
  contents: read
  security-events: write

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'services/**'
              - 'scripts/**'
              - 'infra/**'
              - 'clients/**'
              - 'policies/**'
            docs:
              - 'docs/**'
              - '**/*.md'

  lint:
    name: Ruff lint
    runs-on: ubuntu-latest
    needs: changes
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt
      - run: ruff check --output-format=github .
      - name: Black (check only)
        run: black --check .
      - name: Pylint
        run: pylint services
      - name: Vulture (dead code)
        run: |
          vulture . scripts/vulture_whitelist.py \
            --min-confidence 80 \
            --exclude "wheelhouse,infra/keys,backups,__pycache__"

  typecheck:
    name: mypy
    runs-on: ubuntu-latest
    needs: changes
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt
      - run: mypy services clients

  test:
    name: Unit tests with coverage
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt
      - run: pytest -m "not integration" --cov-fail-under=0
      - name: Upload coverage XML
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml
          if-no-files-found: warn

  build-images:
    name: Build images (no push)
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, changes]
    if: github.event_name != 'pull_request' || (needs.changes.outputs.code == 'true' && !contains(toJson(github.event.pull_request.labels), 'skip-integration'))
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python (for optional wheelhouse populate)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Populate wheelhouse if missing
        run: |
          if [ ! -d wheelhouse ] || [ -z "$(ls -A wheelhouse 2>/dev/null)" ]; then
            python -m pip install --upgrade pip
            python scripts/download-wheels.py
          else
            echo "wheelhouse/ already present; skipping population"
          fi
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build mcp-gateway
        id: build_gateway
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/mcp-gateway/Dockerfile
          tags: gateway:test
          load: true
          provenance: false
          sbom: false
      - name: Build mcp-policy
        id: build_policy
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/mcp-policy/Dockerfile
          tags: policy:test
          load: true
          provenance: false
          sbom: false
      - name: Build mcp-audit
        id: build_audit
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/mcp-audit/Dockerfile
          tags: audit:test
          load: true
          provenance: false
          sbom: false
      - name: Build mcp-lineage
        id: build_lineage
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/mcp-lineage/Dockerfile
          tags: lineage:test
          load: true
          provenance: false
          sbom: false

  trivy:
    name: Trivy scan
    runs-on: ubuntu-latest
    needs: build-images
    if: needs.build-images.result == 'success'
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Scan images and upload SARIF
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: 'image'
          image-ref: 'gateway:test,policy:test,audit:test,lineage:test'
          format: 'sarif'
          output: 'trivy-results.sarif'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
      - uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif

  sbom:
    name: SBOM (CycloneDX)
    runs-on: ubuntu-latest
    needs: build-images
    if: needs.build-images.result == 'success'
    steps:
      - name: Generate SBOMs with Syft
        uses: anchore/sbom-action@v0
        with:
          image: 'gateway:test'
          format: 'cyclonedx-json'
          artifact-name: 'sbom-gateway.cdx.json'
      - name: Generate SBOMs with Syft (policy)
        uses: anchore/sbom-action@v0
        with:
          image: 'policy:test'
          format: 'cyclonedx-json'
          artifact-name: 'sbom-policy.cdx.json'
      - name: Generate SBOMs with Syft (audit)
        uses: anchore/sbom-action@v0
        with:
          image: 'audit:test'
          format: 'cyclonedx-json'
          artifact-name: 'sbom-audit.cdx.json'
      - name: Generate SBOMs with Syft (lineage)
        uses: anchore/sbom-action@v0
        with:
          image: 'lineage:test'
          format: 'cyclonedx-json'
          artifact-name: 'sbom-lineage.cdx.json'

  integration:
    name: Integration tests (Docker Compose)
    runs-on: ubuntu-latest
    needs: [test, changes]
    if: |
      (github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'run-integration')) &&
      needs.changes.outputs.code == 'true'
    env:
      POSTGRES_USER: mcp
      POSTGRES_PASSWORD: ci-local-pass
      POSTGRES_DB: mcpgov
      DATABASE_URL: postgresql://mcp:ci-local-pass@db:5432/mcpgov
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Set up Python (for wheelhouse)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Populate wheelhouse
        run: |
          python -m pip install --upgrade pip
          python scripts/download-wheels.py
      - name: Docker info
        run: |
          docker --version
          docker compose version
      - name: Build and start stack
        run: |
          docker compose build
          docker compose up -d
      - name: Wait for db-migrate to complete
        run: |
          echo "Waiting for db-migrate service to complete..."
          # Wait for completion message in logs (up to 2 minutes)
          for i in {1..60}; do
            echo "Attempt $i: Checking db-migrate logs..."
            
            # Check if completion message appears in logs
            if docker compose logs db-migrate 2>/dev/null | grep -q "=== Migration complete ==="; then
              echo "db-migrate completed successfully (found completion message)"
              docker compose logs db-migrate | tail -15
              
              # Verify exit code if available
              exit_code=$(docker compose ps db-migrate --format json 2>/dev/null | jq -r '.[0].ExitCode // empty' || echo "")
              if [ -n "$exit_code" ] && [ "$exit_code" != "0" ] && [ "$exit_code" != "null" ]; then
                echo "ERROR: db-migrate exit code was $exit_code"
                exit 1
              fi
              echo "Exit code check passed (code: ${exit_code:-not available})"
              exit 0
            fi
            
            # Check for error patterns
            if docker compose logs db-migrate 2>/dev/null | grep -q "ERROR:"; then
              echo "db-migrate encountered an error"
              docker compose logs db-migrate
              exit 1
            fi
            
            sleep 2
          done
          echo "db-migrate did not complete in time (waited 2 minutes)"
          docker compose logs db-migrate
          exit 1
      - name: Wait for gateway health
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:8080/mcp-gateway/healthz > /dev/null; then
              echo "Gateway healthy"; exit 0;
            fi
            sleep 5
          done
          echo "Gateway failed to become healthy in time"; docker compose ps; exit 1
      - name: Run full test suite
        env:
          PYTEST_ADDOPTS: "-q"
        run: |
          pytest
      - name: Tear down stack
        if: always()
        run: |
          docker compose down -v --remove-orphans

