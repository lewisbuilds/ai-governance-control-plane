---
apiVersion: v1
kind: ConfigMap
metadata:
  name: pgbackrest-config
  namespace: ai-governance
  labels:
    app: pgbackrest
    app.kubernetes.io/part-of: ai-governance
data:
  pgbackrest.conf: |
    [global]
    repo1-path=/var/lib/pgbackrest
    repo1-retention-full=4
    repo1-retention-diff=3
    repo1-retention-archive=14
    
    # Optional: S3 configuration (uncomment and configure for cloud storage)
    # repo1-type=s3
    # repo1-s3-bucket=your-backup-bucket
    # repo1-s3-region=us-east-1
    # repo1-s3-endpoint=s3.amazonaws.com
    # repo1-s3-key=<key>
    # repo1-s3-key-secret=<secret>
    
    log-level-console=info
    log-level-file=debug
    log-path=/var/log/pgbackrest
    
    process-max=2
    
    [mcpgov]
    pg1-path=/var/lib/postgresql/data
    pg1-port=5432
    pg1-socket-path=/var/run/postgresql
    pg1-user=postgres
    
    # Archive settings
    archive-async=y
    archive-push-queue-max=1073741824

  postgresql-archive.conf: |
    # PostgreSQL archive configuration for pgBackRest
    # These settings should be added to postgresql.conf or included via include directive
    
    # Enable WAL archiving
    archive_mode = on
    archive_command = 'pgbackrest --stanza=mcpgov archive-push %p'
    
    # Archive timeout (force WAL switch after this time)
    archive_timeout = 60
    
    # WAL settings for better backup performance
    wal_level = replica
    max_wal_senders = 3
    wal_keep_size = 1024
    
  restore-validation.sh: |
    #!/bin/bash
    set -e
    
    RESTORE_DB="mcpgov_restore_test"
    RESTORE_PATH="/var/lib/postgresql/restore-test"
    
    echo "Starting restore validation..."
    echo "Timestamp: $(date)"
    
    # Check if stanza is valid
    pgbackrest --stanza=mcpgov info
    
    # Create restore directory
    mkdir -p "$RESTORE_PATH"
    
    # Perform restore to test directory
    echo "Performing restore to $RESTORE_PATH..."
    pgbackrest --stanza=mcpgov --pg1-path="$RESTORE_PATH" --type=default restore
    
    # Verify critical files exist
    if [ ! -f "$RESTORE_PATH/PG_VERSION" ]; then
      echo "ERROR: Restore validation failed - PG_VERSION not found"
      exit 1
    fi
    
    if [ ! -d "$RESTORE_PATH/base" ]; then
      echo "ERROR: Restore validation failed - base directory not found"
      exit 1
    fi
    
    echo "Restore validation successful!"
    echo "Cleaned up test restore directory"
    rm -rf "$RESTORE_PATH"
    
    exit 0
